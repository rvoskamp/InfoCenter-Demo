const kStoreKey="edx_oauth2_sso";Object.keys||(Object.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t});const EdxAuth={config:null,utils:{rand:function(e,t){const n=window.crypto||window.msCrypto,o=new Uint32Array(1);n.getRandomValues(o);const r=o[0]/4294967296;if(e>t){const n=e;e=t,t=n}return(e=Math.ceil(e))===(t=Math.floor(t))&&(t=e+1),r*(t-e)+e},generateRandomString:function(e){var t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",o=n.length;for(var r=0;r<e;r++)t+=n.charAt(Math.floor(this.rand(0,o)));return t},base64URL:function(e){return e.toString(CryptoJS.enc.Base64).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},generateCodeVerifier:function(){return EdxAuth.utils.generateRandomString(128)},generateChallenge:function(e){return EdxAuth.utils.base64URL(CryptoJS.SHA256(e))}},network:{_send:function(e,t,n,o){return new Promise(function(r,i){let c=new XMLHttpRequest;if(c.open(e?"POST":"GET",t,!0),c.onreadystatechange=function(){4===c.readyState&&(200===c.status||302===c.status?r(c.response):i(c.response))},n){const e=Object.keys(n),t=e?e.length:0;for(let o=0;o<t;o++){const t=e[o];c.setRequestHeader(t,n[t])}}c.onerror=i,c.send(o)})},postData:function(e,t,n){return EdxAuth.network._send(!0,e,t,n)},getData:function(e,t){return EdxAuth.network._send(!1,e,t,void 0)}},getCode:function(e,t){let n=EdxAuth.utils.generateCodeVerifier();e.code_verifier=n;let o=EdxAuth.utils.generateChallenge(n),r=e.client_id,i=e.scope?encodeURIComponent(e.scope):null,c=i?"&scope="+i:"",a=e.redirect_uri=encodeURIComponent(location.origin+location.pathname),s=EdxUrlParse.getQueryFromURL(location.href,"state"),u=s?"&state="+s:"";EdxAuth.saveAuthData(e),t+="?response_type=code&redirect_uri="+a+c+"&client_id="+r+u+"&code_challenge_method=S256&code_challenge="+o,location.href=t},findCode:function(e){let t=null,n=e.indexOf("code=")+5;return n>4&&(t=e.substr(n).split("&")[0]),t},findError:function(e){let t=null,n=e.indexOf("error=")+6;if(n>5){const o=e.substr(n).split("&");t=decodeURIComponent(o[0]),o.length>2&&0===o[1].indexOf("error_description=")&&(t+=": "+decodeURIComponent(o[1].substr(18)))}return t},silentRenew:function(e,t){let n=e.client_id,o=e.scope?encodeURIComponent(e.scope):null,r=o?"&scope="+o:"",i=EdxAuth.utils.generateCodeVerifier(),c=e.tokens?e.tokens.id_token:null,a=c?"&id_token_hint="+c:"",s=e.redirect_uri=encodeURIComponent(location.origin+location.pathname);t+="?response_type=id_tokenid_token+token"+a+"&prompt=none&redirect_uri="+s+r+"&client_id="+n+"&state=*&nonce="+i,setTimeout(function(){EdxAuth.network.getData(t).then(function(e){},handleError)},500)},getAccessToken:function(e,t){let n=null,o=EdxAuth.getAuthData();return new Promise(function(r,i){const c=function(e){localStorage.removeItem(kStoreKey),i(e)};o||i("no auth"),!o.config&&t&&(o.config=t),o.config||i("no config");let a=o.config.token_endpoint;a||i("no tokenURL");let s=o.code_verifier;s||i("no code_verifier");let u=o.client_id;u||i("no client_id");let l=o.redirect_uri;l||i("no redirect_uri");const d={"Content-Type":"application/x-www-form-urlencoded"};let f="client_id="+u+"&redirect_uri="+l;const p=o.tokens?o.tokens.refresh_token:void 0;e?f+="&grant_type=authorization_code&code_verifier="+s+"&code="+e:p?f+="&grant_type=refresh_token&refresh_token="+p:c("no refresh token"),setTimeout(function(){EdxAuth.network.postData(a,d,f).then(function(e){if(e)try{let t=JSON.parse(e);t.access_token?(n=t.access_token,o.tokens=t,EdxAuth.saveAuthData(o),r(n)):c("no token")}catch(e){c(e)}},c)},500)})},getConfig:function(e){return new Promise(function(t,n){EdxAuth.network.getData(e+"/.well-known/openid-configuration").then(function(e){EdxAuth.config=JSON.parse(e),t(EdxAuth.config)},n)})},logoff:function(e,t,n){t+="?client_id="+e+"&post_logout_redirect_uri="+n,location.href=t},getAuthData:function(){let e=null,t=localStorage.getItem(kStoreKey);if(t)try{e=JSON.parse(t)}catch(t){e=null}return e},saveAuthData:function(e){EdxAuth.config&&(e.config=EdxAuth.config);let t=JSON.stringify(e);localStorage.setItem(kStoreKey,t)}},EdxUrlParse={parseUrlOptions:{strictMode:!0,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},getParams:function(e){let t,n={},o=e.query.replace(/^\?/,"").split("&"),r=o.length,i=0;for(;i<r;i++)o[i]&&(n[(t=o[i].split("="))[0]]=t[1]);return n},parseURL:function(e){let t=EdxUrlParse.parseUrlOptions,n=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},r=14;for(;r--;)o[t.key[r]]=n[r]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,n,r){n&&(o[t.q.name][n]=r)}),o.params=EdxUrlParse.getParams(o),o.path=o.path.split("/"),o},getQueryFromURL:function(e,t){return EdxUrlParse.parseURL(e).params[t]},decodeChildRouteURL:function(e){let t=e.split("#ch_")[0];if(e.indexOf("(")>0&&e.indexOf(")")==e.length-1){let n=(t=decodeURIComponent(e)).split(";");"="==(t=(t=n[1]).slice(0,t.length-1))[t.length-1]&&(t=t.slice(0,t.length-1))}return t},getDescFromURL:function(e){let t=EdxUrlParse.parseURL(e),n=t.path.length,o={type:t.path[1]||"",id:n>2?t.path[2]:"",lib:t.params.library||"",action:t.params.action||"open"};return o.id.startsWith("FP-FilePart")&&(o.id=decodeURIComponent(decodeURIComponent(o.id))),o}},EDX_Transforms={b64EncodeUnicode:function(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt("0x"+t,16))}))}};